<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard - Painel da Assessoria</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap');
        body {
            font-family: 'Poppins', sans-serif;
        }
        .gradient-bg {
            background: linear-gradient(135deg, #9c2851 0%, #b8336a 50%, #a0295e 100%);
        }
        .text-marsala { color: #9c2851; }
        .text-gold { color: #d4af37; }
        .btn-marsala {
            background: linear-gradient(135deg, #9c2851 0%, #b8336a 100%);
        }
        .btn-gold {
            background: linear-gradient(135deg, #d4af37 0%, #f4d03f 100%);
            color: #333;
        }
        .card-shadow {
            box-shadow: 0 10px 25px -5px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
        }
        .stat-card {
            background: linear-gradient(135deg, #9c2851 0%, #b8336a 100%);
        }
        .stat-card-green {
            background: linear-gradient(135deg, #10b981 0%, #059669 100%);
        }
        .stat-card-blue {
            background: linear-gradient(135deg, #3b82f6 0%, #1d4ed8 100%);
        }
        .stat-card-gold {
            background: linear-gradient(135deg, #d4af37 0%, #f4d03f 100%);
            color: #333;
        }
        .fade-in {
            animation: fadeIn 0.6s ease-in;
        }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .btn-hover:hover {
            transform: translateY(-2px);
            transition: all 0.3s ease;
        }
        .table-row:hover {
            background-color: #f8fafc;
            transform: scale(1.01);
            transition: all 0.2s ease;
        }
        .copy-success {
            animation: copySuccess 0.5s ease-in-out;
        }
        @keyframes copySuccess {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.1); }
        }
    </style>
</head>
<body class="bg-gray-50 min-h-screen">
    <!-- Header -->
    <header class="gradient-bg shadow-lg">
        <div class="container mx-auto px-4 py-6">
            <div class="flex items-center justify-between">
                <div class="flex items-center space-x-4">
                    <div class="bg-white rounded-full p-3">
                        <i class="fas fa-heart text-2xl text-marsala"></i>
                    </div>
                    <div>
                        <h1 id="weddingTitle" class="text-2xl font-bold text-white">Carregando...</h1>
                        <p class="text-pink-100">Dashboard do Casamento</p>
                    </div>
                </div>
                
                <div class="flex items-center space-x-4">
                    <button 
                        id="refreshBtn"
                        class="bg-white bg-opacity-20 text-white px-4 py-2 rounded-lg hover:bg-opacity-30 transition-all duration-300 btn-hover"
                        title="Atualizar dados"
                    >
                        <i class="fas fa-sync-alt mr-2"></i>Atualizar
                    </button>
                    
                    <button 
                        id="exportBtn"
                        class="btn-gold text-black px-4 py-2 rounded-lg hover:shadow-lg transition-all duration-300 btn-hover font-semibold"
                        title="Exportar para CSV"
                    >
                        <i class="fas fa-download mr-2"></i>Exportar
                    </button>

                    <button 
                        id="shareBtn"
                        class="bg-blue-500 text-white px-4 py-2 rounded-lg hover:bg-blue-600 transition-all duration-300 btn-hover"
                        title="Compartilhar Dashboard"
                    >
                        <i class="fas fa-share-alt mr-2"></i>Compartilhar
                    </button>

                    <button 
                        id="backBtn"
                        class="bg-white bg-opacity-20 text-white px-4 py-2 rounded-lg hover:bg-opacity-30 transition-all duration-300 btn-hover"
                        title="Voltar para lista de casamentos"
                    >
                        <i class="fas fa-arrow-left mr-2"></i>Voltar
                    </button>
                    
                    <button 
                        id="logoutBtn"
                        class="bg-red-500 text-white px-4 py-2 rounded-lg hover:bg-red-600 transition-all duration-300 btn-hover"
                        title="Sair"
                    >
                        <i class="fas fa-sign-out-alt mr-2"></i>Sair
                    </button>
                </div>
            </div>
        </div>
    </header>

    <!-- Main Content -->
    <main class="container mx-auto px-4 py-8">
        <!-- Loading State -->
        <div id="loading" class="text-center py-12">
            <i class="fas fa-spinner fa-spin text-4xl text-blue-500 mb-4"></i>
            <p class="text-gray-600">Carregando dados...</p>
        </div>

        <!-- Dashboard Content -->
        <div id="dashboard" class="hidden">
            <!-- Estatísticas -->
            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-8">
                <!-- Total de Confirmações -->
                <div class="stat-card text-white rounded-xl p-6 card-shadow fade-in">
                    <div class="flex items-center justify-between">
                        <div>
                            <p class="text-blue-100 text-sm font-medium">Total de Confirmações</p>
                            <p id="totalConfirmations" class="text-3xl font-bold">0</p>
                        </div>
                        <i class="fas fa-users text-4xl text-blue-200"></i>
                    </div>
                </div>

                <!-- Total de Adultos -->
                <div class="stat-card-green text-white rounded-xl p-6 card-shadow fade-in">
                    <div class="flex items-center justify-between">
                        <div>
                            <p class="text-green-100 text-sm font-medium">Total de Adultos</p>
                            <p id="totalAdults" class="text-3xl font-bold">0</p>
                        </div>
                        <i class="fas fa-user text-4xl text-green-200"></i>
                    </div>
                </div>

                <!-- Total de Crianças -->
                <div class="stat-card-blue text-white rounded-xl p-6 card-shadow fade-in">
                    <div class="flex items-center justify-between">
                        <div>
                            <p class="text-blue-100 text-sm font-medium">Total de Crianças</p>
                            <p id="totalChildren" class="text-3xl font-bold">0</p>
                        </div>
                        <i class="fas fa-child text-4xl text-blue-200"></i>
                    </div>
                </div>

                <!-- Total Geral -->
                <div class="stat-card-gold text-black rounded-xl p-6 card-shadow fade-in">
                    <div class="flex items-center justify-between">
                        <div>
                            <p class="text-yellow-800 text-sm font-medium">Total de Pessoas</p>
                            <p id="totalPeople" class="text-3xl font-bold">0</p>
                        </div>
                        <i class="fas fa-heart text-4xl text-yellow-700"></i>
                    </div>
                </div>
            </div>

            <!-- Lista de Convidados -->
            <div class="bg-white rounded-xl shadow-lg p-6 fade-in">
                <div class="flex items-center justify-between mb-6">
                    <h2 class="text-2xl font-bold text-gray-800">
                        <i class="fas fa-list mr-2 text-blue-500"></i>Lista de Convidados
                    </h2>
                    
                    <!-- Filtro de busca -->
                    <div class="relative">
                        <input 
                            type="text" 
                            id="searchInput"
                            placeholder="Buscar por nome..."
                            class="pl-10 pr-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                        >
                        <i class="fas fa-search absolute left-3 top-1/2 transform -translate-y-1/2 text-gray-400"></i>
                    </div>
                </div>

                <!-- Tabela Responsiva -->
                <div class="overflow-x-auto">
                    <table class="w-full table-auto">
                        <thead>
                            <tr class="bg-gray-50 text-gray-700 text-sm font-semibold">
                                <th class="px-4 py-3 text-left rounded-l-lg">ID</th>
                                <th class="px-4 py-3 text-left">Responsável</th>
                                <th class="px-4 py-3 text-left">Detalhes</th>
                                <th class="px-4 py-3 text-center">Adultos</th>
                                <th class="px-4 py-3 text-center">Crianças</th>
                                <th class="px-4 py-3 text-center">Total</th>
                                <th class="px-4 py-3 text-left">Telefone</th>
                                <th class="px-4 py-3 text-left">Data/Hora</th>
                                <th class="px-4 py-3 text-center rounded-r-lg">Ações</th>
                            </tr>
                        </thead>
                        <tbody id="guestsTable" class="divide-y divide-gray-200">
                            <!-- Dados serão inseridos aqui via JavaScript -->
                        </tbody>
                    </table>
                </div>

                <!-- Estado vazio -->
                <div id="emptyState" class="hidden text-center py-12">
                    <i class="fas fa-inbox text-6xl text-gray-300 mb-4"></i>
                    <h3 class="text-xl font-semibold text-gray-600 mb-2">Nenhuma confirmação ainda</h3>
                    <p class="text-gray-500">As confirmações aparecerão aqui conforme os convidados respondem</p>
                </div>

                <!-- Estado sem resultados de busca -->
                <div id="noResults" class="hidden text-center py-12">
                    <i class="fas fa-search text-6xl text-gray-300 mb-4"></i>
                    <h3 class="text-xl font-semibold text-gray-600 mb-2">Nenhum resultado encontrado</h3>
                    <p class="text-gray-500">Tente buscar com outros termos</p>
                </div>
            </div>
        </div>

        <!-- Mensagem de Erro -->
        <div id="error-message" class="hidden bg-red-50 border border-red-200 rounded-xl p-6 text-center">
            <i class="fas fa-exclamation-triangle text-4xl text-red-500 mb-4"></i>
            <h3 class="text-xl font-semibold text-red-800 mb-2">Erro ao carregar dados</h3>
            <p id="error-text" class="text-red-600 mb-4"></p>
            <button 
                onclick="loadDashboard()"
                class="bg-red-500 text-white px-6 py-2 rounded-lg hover:bg-red-600 transition-colors"
            >
                Tentar novamente
            </button>
        </div>

        <!-- Modal de Compartilhamento -->
        <div id="shareModal" class="fixed inset-0 bg-black bg-opacity-50 hidden z-50">
            <div class="flex items-center justify-center min-h-screen p-4">
                <div class="bg-white rounded-xl shadow-2xl max-w-md w-full p-6">
                    <div class="flex items-center justify-between mb-4">
                        <h3 class="text-xl font-bold text-gray-800">
                            <i class="fas fa-share-alt mr-2 text-blue-500"></i>Compartilhar Dashboard
                        </h3>
                        <button id="closeShareModal" class="text-gray-400 hover:text-gray-600">
                            <i class="fas fa-times text-xl"></i>
                        </button>
                    </div>
                    
                    <p class="text-gray-600 mb-4">
                        Compartilhe este link com os noivos para que eles possam acompanhar as confirmações:
                    </p>
                    
                    <div class="flex items-center space-x-2 mb-4">
                        <input 
                            type="text" 
                            id="shareLink" 
                            readonly
                            class="flex-1 px-3 py-2 border border-gray-300 rounded-lg bg-gray-50 text-gray-700"
                        >
                        <button 
                            id="copyLinkBtn"
                            class="px-4 py-2 bg-blue-500 text-white rounded-lg hover:bg-blue-600 transition-colors"
                        >
                            <i class="fas fa-copy mr-2"></i>Copiar
                        </button>
                    </div>
                    
                    <div class="flex space-x-2">
                        <button 
                            id="whatsappShare"
                            class="flex-1 px-4 py-2 bg-green-500 text-white rounded-lg hover:bg-green-600 transition-colors"
                        >
                            <i class="fab fa-whatsapp mr-2"></i>WhatsApp
                        </button>
                        <button 
                            id="emailShare"
                            class="flex-1 px-4 py-2 bg-blue-500 text-white rounded-lg hover:bg-blue-600 transition-colors"
                        >
                            <i class="fas fa-envelope mr-2"></i>Email
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Modal de Confirmação para Remover Convidado -->
        <div id="removeGuestModal" class="fixed inset-0 bg-black bg-opacity-50 hidden z-50">
            <div class="flex items-center justify-center min-h-screen p-4">
                <div class="bg-white rounded-xl shadow-2xl max-w-md w-full p-6">
                    <div class="flex items-center justify-between mb-4">
                        <h3 class="text-xl font-bold text-gray-800">
                            <i class="fas fa-exclamation-triangle mr-2 text-red-500"></i>Confirmar Remoção
                        </h3>
                        <button id="closeRemoveModal" class="text-gray-400 hover:text-gray-600">
                            <i class="fas fa-times text-xl"></i>
                        </button>
                    </div>
                    
                    <div class="mb-6">
                        <p class="text-gray-600 mb-2">
                            Tem certeza que deseja remover o convidado:
                        </p>
                        <p class="font-semibold text-gray-800" id="guestNameToRemove"></p>
                        <p class="text-sm text-red-600 mt-2">
                            <i class="fas fa-info-circle mr-1"></i>
                            Esta ação não pode ser desfeita.
                        </p>
                    </div>
                    
                    <div class="flex space-x-3">
                        <button 
                            id="confirmRemoveGuest"
                            class="flex-1 px-4 py-2 bg-red-600 text-white rounded-lg hover:bg-red-700 transition-colors font-medium"
                        >
                            <i class="fas fa-trash mr-2"></i>Sim, Remover
                        </button>
                        <button 
                            id="cancelRemoveGuest"
                            class="flex-1 px-4 py-2 bg-gray-300 text-gray-700 rounded-lg hover:bg-gray-400 transition-colors font-medium"
                        >
                            Cancelar
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <script>
        let allGuests = [];
        let filteredGuests = [];
        let currentWedding = null;
        let weddingSlug = null;

        // Elementos do DOM
        const loading = document.getElementById('loading');
        const dashboard = document.getElementById('dashboard');
        const errorMessage = document.getElementById('error-message');
        const errorText = document.getElementById('error-text');
        const refreshBtn = document.getElementById('refreshBtn');
        const exportBtn = document.getElementById('exportBtn');
        const backBtn = document.getElementById('backBtn');
        const logoutBtn = document.getElementById('logoutBtn');
        const searchInput = document.getElementById('searchInput');
        const guestsTable = document.getElementById('guestsTable');
        const emptyState = document.getElementById('emptyState');
        const noResults = document.getElementById('noResults');

        // Elementos de estatísticas
        const totalConfirmations = document.getElementById('totalConfirmations');
        const totalAdults = document.getElementById('totalAdults');
        const totalChildren = document.getElementById('totalChildren');
        const totalPeople = document.getElementById('totalPeople');

        // Função para mostrar erro
        function showError(message) {
            loading.classList.add('hidden');
            dashboard.classList.add('hidden');
            errorMessage.classList.remove('hidden');
            errorText.textContent = message;
        }

        // Função para formatar data
        function formatDate(dateString) {
            const date = new Date(dateString);
            return date.toLocaleString('pt-BR');
        }

        // Função para atualizar estatísticas
        function updateStats(stats) {
            totalConfirmations.textContent = stats.total_confirmations || 0;
            totalAdults.textContent = stats.total_adults || 0;
            totalChildren.textContent = stats.total_children || 0;
            totalPeople.textContent = stats.total_people || 0;
        }

        // Função para recalcular estatísticas localmente
        function recalculateStats() {
            const stats = {
                total_confirmations: allGuests.length,
                total_adults: allGuests.reduce((sum, guest) => sum + (guest.adults || 0), 0),
                total_children: allGuests.reduce((sum, guest) => sum + (guest.children || 0), 0),
                total_people: allGuests.reduce((sum, guest) => sum + (guest.adults || 0) + (guest.children || 0), 0)
            };
            updateStats(stats);
        }

        // Função para renderizar tabela de convidados
        function renderGuestsTable(guests) {
            if (guests.length === 0) {
                guestsTable.innerHTML = '';
                emptyState.classList.remove('hidden');
                noResults.classList.add('hidden');
                return;
            }

            emptyState.classList.add('hidden');
            
            if (searchInput.value && guests.length === 0) {
                noResults.classList.remove('hidden');
                guestsTable.innerHTML = '';
                return;
            } else {
                noResults.classList.add('hidden');
            }

            guestsTable.innerHTML = guests.map(guest => {
                // Preparar detalhes dos adultos
                let adultsDetails = '';
                if (guest.adults_names && guest.adults_names.length > 0) {
                    adultsDetails = guest.adults_names.join(', ');
                }
                
                // Preparar detalhes das crianças
                let childrenDetails = '';
                if (guest.children_details && guest.children_details.length > 0) {
                    childrenDetails = guest.children_details.map(child => 
                        `${child.name} (${child.over6 ? '+6' : '-6'})`
                    ).join(', ');
                }
                
                // Combinar detalhes
                let allDetails = [];
                if (adultsDetails) allDetails.push(`<strong>Adultos:</strong> ${adultsDetails}`);
                if (childrenDetails) allDetails.push(`<strong>Crianças:</strong> ${childrenDetails}`);
                const detailsHtml = allDetails.join('<br>');
                
                return `
                    <tr class="table-row">
                        <td class="px-4 py-3 text-sm font-medium text-gray-900">#${guest.id}</td>
                        <td class="px-4 py-3">
                            <div class="font-medium text-gray-900">${guest.name}</div>
                        </td>
                        <td class="px-4 py-3 text-sm text-gray-700">
                            <div class="max-w-xs">${detailsHtml || 'Sem detalhes'}</div>
                        </td>
                        <td class="px-4 py-3 text-center">
                            <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-green-100 text-green-800">
                                ${guest.adults}
                            </span>
                        </td>
                        <td class="px-4 py-3 text-center">
                            <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-blue-100 text-blue-800">
                                ${guest.children}
                            </span>
                        </td>
                        <td class="px-4 py-3 text-center">
                            <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-purple-100 text-purple-800">
                                ${guest.adults + guest.children}
                            </span>
                        </td>
                        <td class="px-4 py-3 text-sm text-gray-900">***${guest.phone}</td>
                        <td class="px-4 py-3 text-sm text-gray-500">${formatDate(guest.created_at)}</td>
                        <td class="px-4 py-3 text-center">
                            <button 
                                onclick="removeGuest(${guest.id}, '${guest.name}')"
                                class="inline-flex items-center px-3 py-1.5 border border-transparent text-xs font-medium rounded-md text-white bg-red-600 hover:bg-red-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-red-500 transition-colors"
                                title="Remover convidado"
                            >
                                <i class="fas fa-trash mr-1"></i>Remover
                            </button>
                        </td>
                    </tr>
                `;
            }).join('');
        }

        // Função para filtrar convidados
        function filterGuests(searchTerm) {
            if (!searchTerm) {
                filteredGuests = allGuests;
            } else {
                filteredGuests = allGuests.filter(guest => 
                    guest.name.toLowerCase().includes(searchTerm.toLowerCase())
                );
            }
            renderGuestsTable(filteredGuests);
        }

        // Obter slug da URL
        function getWeddingSlug() {
            const pathParts = window.location.pathname.split('/');
            return pathParts[pathParts.length - 1];
        }

        // Função para carregar dados do dashboard
        async function loadDashboard() {
            try {
                loading.classList.remove('hidden');
                dashboard.classList.add('hidden');
                errorMessage.classList.add('hidden');

                // Obter slug do casamento
                weddingSlug = getWeddingSlug();

                // Carregar dados em paralelo
                const [weddingResponse, guestsResponse, statsResponse] = await Promise.all([
                    fetch(`/api/admin/wedding/${weddingSlug}`),
                    fetch(`/api/admin/wedding/${weddingSlug}/guests`),
                    fetch(`/api/admin/wedding/${weddingSlug}/stats`)
                ]);

                if (!weddingResponse.ok || !guestsResponse.ok || !statsResponse.ok) {
                    throw new Error('Erro ao carregar dados');
                }

                currentWedding = await weddingResponse.json();
                const guests = await guestsResponse.json();
                const stats = await statsResponse.json();

                // Atualizar título
                document.getElementById('weddingTitle').textContent = 
                    `${currentWedding.bride_name} & ${currentWedding.groom_name}`;

                // Atualizar dados locais
                allGuests = guests;
                filteredGuests = guests;

                // Atualizar interface
                updateStats(stats);
                renderGuestsTable(filteredGuests);

                // Mostrar dashboard
                loading.classList.add('hidden');
                dashboard.classList.remove('hidden');

                // Aplicar animações
                const elements = document.querySelectorAll('.fade-in');
                elements.forEach((el, index) => {
                    el.style.animationDelay = `${index * 0.1}s`;
                });

            } catch (error) {
                console.error('Erro ao carregar dashboard:', error);
                showError('Erro ao carregar dados. Verifique sua conexão e tente novamente.');
            }
        }

        // Função para fazer logout
        async function logout() {
            try {
                const response = await fetch('/api/admin/logout', {
                    method: 'POST'
                });

                if (response.ok) {
                    window.location.href = '/admin';
                } else {
                    alert('Erro ao fazer logout');
                }
            } catch (error) {
                console.error('Erro no logout:', error);
                alert('Erro ao fazer logout');
            }
        }

        // Função para exportar dados
        async function exportData() {
            try {
                exportBtn.disabled = true;
                exportBtn.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i>Exportando...';

                const response = await fetch(`/api/admin/wedding/${weddingSlug}/export`);
                
                if (response.ok) {
                    // Criar download do arquivo
                    const blob = await response.blob();
                    const url = window.URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.style.display = 'none';
                    a.href = url;
                    a.download = 'convidados.csv';
                    document.body.appendChild(a);
                    a.click();
                    window.URL.revokeObjectURL(url);
                    document.body.removeChild(a);
                } else {
                    throw new Error('Erro ao exportar dados');
                }
            } catch (error) {
                console.error('Erro na exportação:', error);
                alert('Erro ao exportar dados. Tente novamente.');
            } finally {
                exportBtn.disabled = false;
                exportBtn.innerHTML = '<i class="fas fa-download mr-2"></i>Exportar';
            }
        }

        // Função para mostrar modal de compartilhamento
        function showShareModal() {
            const shareUrl = `${window.location.origin}/share/${weddingSlug}`;
            document.getElementById('shareLink').value = shareUrl;
            document.getElementById('shareModal').classList.remove('hidden');
        }

        // Função para fechar modal de compartilhamento
        function closeShareModal() {
            document.getElementById('shareModal').classList.add('hidden');
        }

        // Função para copiar link
        async function copyLink() {
            const shareLink = document.getElementById('shareLink');
            try {
                await navigator.clipboard.writeText(shareLink.value);
                const copyBtn = document.getElementById('copyLinkBtn');
                copyBtn.innerHTML = '<i class="fas fa-check mr-2"></i>Copiado!';
                copyBtn.classList.add('bg-green-500');
                
                setTimeout(() => {
                    copyBtn.innerHTML = '<i class="fas fa-copy mr-2"></i>Copiar';
                    copyBtn.classList.remove('bg-green-500');
                }, 2000);
            } catch (error) {
                console.error('Erro ao copiar:', error);
                // Fallback para navegadores mais antigos
                shareLink.select();
                document.execCommand('copy');
                const copyBtn = document.getElementById('copyLinkBtn');
                copyBtn.innerHTML = '<i class="fas fa-check mr-2"></i>Copiado!';
                setTimeout(() => {
                    copyBtn.innerHTML = '<i class="fas fa-copy mr-2"></i>Copiar';
                }, 2000);
            }
        }

        // Função para compartilhar no WhatsApp
        function shareWhatsApp() {
            const shareLink = document.getElementById('shareLink').value;
            const text = `Dashboard das confirmações do nosso casamento: ${shareLink}`;
            const url = `https://wa.me/?text=${encodeURIComponent(text)}`;
            window.open(url, '_blank');
        }

        // Função para compartilhar por email
        function shareEmail() {
            const shareLink = document.getElementById('shareLink').value;
            const subject = 'Dashboard das Confirmações - Nosso Casamento';
            const body = `Olá!\n\nAqui está o link para acompanhar as confirmações do nosso casamento:\n\n${shareLink}\n\nAtenciosamente,\nAssessoria`;
            const url = `mailto:?subject=${encodeURIComponent(subject)}&body=${encodeURIComponent(body)}`;
            window.open(url);
        }

        // Event Listeners
        refreshBtn.addEventListener('click', loadDashboard);
        exportBtn.addEventListener('click', exportData);
        shareBtn.addEventListener('click', showShareModal);
        backBtn.addEventListener('click', () => {
            window.location.href = '/admin/weddings';
        });
        logoutBtn.addEventListener('click', logout);

        // Função para remover convidado
        let guestToRemove = null;

        function removeGuest(guestId, guestName) {
            guestToRemove = guestId;
            document.getElementById('guestNameToRemove').textContent = guestName;
            document.getElementById('removeGuestModal').classList.remove('hidden');
        }

        // Função para confirmar remoção
        async function confirmRemoveGuest() {
            if (!guestToRemove) return;

            try {
                const response = await fetch(`/api/admin/wedding/${weddingSlug}/guests/${guestToRemove}`, {
                    method: 'DELETE'
                });

                if (response.ok) {
                    // Remover da lista local
                    allGuests = allGuests.filter(guest => guest.id !== guestToRemove);
                    filteredGuests = filteredGuests.filter(guest => guest.id !== guestToRemove);
                    
                    // Atualizar interface
                    recalculateStats();
                    renderGuestsTable(filteredGuests);
                    
                    // Fechar modal
                    document.getElementById('removeGuestModal').classList.add('hidden');
                    
                    // Mostrar mensagem de sucesso
                    showSuccessMessage('Convidado removido com sucesso!');
                } else {
                    const error = await response.json();
                    showErrorMessage(`Erro ao remover convidado: ${error.error || 'Erro desconhecido'}`);
                }
            } catch (error) {
                console.error('Erro ao remover convidado:', error);
                showErrorMessage('Erro de conexão ao remover convidado');
            }
        }

        // Função para mostrar mensagem de sucesso
        function showSuccessMessage(message) {
            const successDiv = document.createElement('div');
            successDiv.className = 'fixed top-4 right-4 bg-green-500 text-white px-6 py-3 rounded-lg shadow-lg z-50';
            successDiv.innerHTML = `
                <div class="flex items-center">
                    <i class="fas fa-check-circle mr-2"></i>
                    <span>${message}</span>
                </div>
            `;
            document.body.appendChild(successDiv);
            
            setTimeout(() => {
                successDiv.remove();
            }, 3000);
        }

        // Função para mostrar mensagem de erro
        function showErrorMessage(message) {
            const errorDiv = document.createElement('div');
            errorDiv.className = 'fixed top-4 right-4 bg-red-500 text-white px-6 py-3 rounded-lg shadow-lg z-50';
            errorDiv.innerHTML = `
                <div class="flex items-center">
                    <i class="fas fa-exclamation-circle mr-2"></i>
                    <span>${message}</span>
                </div>
            `;
            document.body.appendChild(errorDiv);
            
            setTimeout(() => {
                errorDiv.remove();
            }, 5000);
        }

        // Event listeners para o modal de compartilhamento
        document.getElementById('closeShareModal').addEventListener('click', closeShareModal);
        document.getElementById('copyLinkBtn').addEventListener('click', copyLink);
        document.getElementById('whatsappShare').addEventListener('click', shareWhatsApp);
        document.getElementById('emailShare').addEventListener('click', shareEmail);

        // Fechar modal ao clicar fora
        document.getElementById('shareModal').addEventListener('click', (e) => {
            if (e.target === document.getElementById('shareModal')) {
                closeShareModal();
            }
        });

        // Event listeners para o modal de remoção
        document.getElementById('closeRemoveModal').addEventListener('click', () => {
            document.getElementById('removeGuestModal').classList.add('hidden');
        });

        document.getElementById('cancelRemoveGuest').addEventListener('click', () => {
            document.getElementById('removeGuestModal').classList.add('hidden');
        });

        document.getElementById('confirmRemoveGuest').addEventListener('click', confirmRemoveGuest);

        // Fechar modal de remoção ao clicar fora
        document.getElementById('removeGuestModal').addEventListener('click', (e) => {
            if (e.target === document.getElementById('removeGuestModal')) {
                document.getElementById('removeGuestModal').classList.add('hidden');
            }
        });

        // Busca em tempo real
        searchInput.addEventListener('input', function(e) {
            filterGuests(e.target.value);
        });

        // Carregar dashboard quando a página carrega
        document.addEventListener('DOMContentLoaded', loadDashboard);

        // Atualização automática a cada 30 segundos
        setInterval(() => {
            if (!document.hidden) {
                loadDashboard();
            }
        }, 30000);
    </script>
</body>
</html>


